# 애그리거트 트랜잭션 관리

## 8.1 애그리거트와 트랜잭션

![[Pasted image 20240321104344.png]]
* 두 스레드 각각 트랜잭션 커밋해 수정 내용 DB 반영 : 애그리거트읠 일관성 깨짐
* DBMS가 지원하는 트랜잭션과 함께 애그리거트 위한 추가 트랜잭션 기법 필요.
	* 선점 잠금, 비선점 잠금

## 8.2 선점 잠금

* **선점 잠금 : 먼저 애그리거트 구한 스레드가 애그리거트 사용 끝날 때까지, 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식.**
	![[Pasted image 20240321113339.png]]
* 보통 DBMS 제공 행단위 잠금 사용해 구현.
	* 오라클 비롯 다수의 DBMS : for update 같은 쿼리 사용해 특정 레코드에 한 커넥션만 접근 가능한 잠금장치 제공.
	* JPA EntityManager : LockModeType을 인자로 받는 find() 메서드 제공.
		* LockModeType.PESSIMISTIC_WRITE 전달시, 해당 엔티티와 매핑된 테이블 이용해 선점 잠금 가능.
	* 하이버네이트 : PESSIMISTIC_WRITE 사용시, for update 쿼리로 선점 잠금
	* 스프링 데이터 JPA : @LOCK

#### 8.2.1 선점 잠금과 교착 상태

* 교착 상태 발생 시기 : 상대적으로 사용자 수 많을 때 ➡️해결) **잠금 구할 때 최대 대기 시간 지정**
	* JPA : hint.put("javax.persistence.lock.timeout") : 지정 시간 내 잠금 못구하면 익셉션.
		* 🚨 DBMS 따라 힌트 적용되는지 확인 필요. (커낵션 단위로만 대기 지정 가능하기도함.)
	* 스프링 데이터 JPA : @QueryHints

## 8.3 비선점 잠금

* 선점 잠금이 해결하지 못하는 문제.
	* ex. 운영자가 조회, 고객도 조회하면서 변경, 운영자도 변경.
* **비선점 잠금 : 동시 접근 막는 대신 변경 데이터를 실제 DBMS에 반영하는 시점에 변경 가능 여부 확인.**
	* 애그리거트에 버전(숫자 타입 프로퍼티) 추가해야함 : 수정할 애그리거트와 매핑 테이블 버전 값이 현재 애그리거트의 버전과 동일한 경우에만 데이터 수정.
	* JPA 지원 : @Version
		* 응용 서비스에서는 버전에 대해 알 필요 없음.
		* 쿼리 실행 결과 수정된 행 개수 0 : 트랜잭션 충돌. ➡️ @Transactional 범위 종료시 익셉션 발생. 
![[Pasted image 20240321121419.png]]
* 비선점 잠금 방식을 여러 트랜잭션으로 확장시) 애그리거트 정보를 뷰로 보여줄 때 버전 정보도 함께 사용자 화면에 전달 ➡️폼 전송시 버전 값이 서버에 전달되도록.
	* versionConflictException : 누군가 애그리거트 수정
	* OptimisticLockingFailureExcpetion : 누군가 거의 동시에 애그리거트 수정
	* 버전 충돌 상황 명시적 구분 필요 없다면) 응용 서비스에 프레임워크용 익셉션 발생시키기.

#### 8.3.1 강제 버전 증가 
* 애그리거트에 애그리거트 루트 외 다른 엔티티 존재하나 다른 엔티티 값만 변경될 때
	1. JPA : 루트 엔티티 버전 값 증가시키지 않음.
		* EntityManager#find() 메서드로 강제 버전 값 증가시키는 잠금 모드 지원.
	2. 스프링 데이터 JPA : @Lock으로 가능.

## 8.4 오프라인 선점 잠금

* **오프라인 선점 잠금 : 여러 트랜잭션에 걸쳐 동시 변경 막음.** 
	* 첫번 째 트랜잭션 시작시 오프라인 잠금 선점, 마지막 트랜잭션에서 잠금 해제.
	* 잠금 해제하지 않고 프로그램 종료시, 다른 사용자는 영원히 잠금 못구함.. ➡️ 잠금 유효시간 필요. 일정 주기로 유효시간 증가시키는 방식도 필요.

#### 8.4.1 오프라인 선점 잠금을 위한 LockManager 인터페이스와 관련 클래스
* 오프라인 선점 잠금은 **잠금 선점 시도, 잠금 확인, 잠금 해제, 잠금 유효시간 연장** 필요.
	* 그를 위한 인터페이스 : LockManager 인터페이스
		* 잠금 시도(tryLock) : LockId 리턴. 어딘가 보관
		* 잠금 확인(checkLock) : 선점하지 않은 사용자가 실행한다면 기능 실행 막음.
		* 잠금 유효시간 확인 : 유효시간 지나면 다른 사용자가 잠금 선점.
		* 잠금 해제(releasLock) : 기능 실행 후 해제.

#### 8.4.2 DB를 이용한 LockManager 구현
* locks 테이블 생
* type(ex. Order)과 id 칼럼을 주요키로 지정 : 동시에 두 사용자가 특정 타입 데이터에 대한 잠금 구하는 것 방지

#### 용어정리
* (JPA)힌트 : 데이터베이스 쿼리 옵티마이저에게 제공되는 힌트를 말합니다. 이 힌트는 쿼리를 실행할 때 데이터베이스 옵티마이저에게 특정 방식으로 쿼리를 처리하도록 지시하는 역할.

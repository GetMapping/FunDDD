### 7.1 여러 애그리거트가 필요한 기능
- 하나의 애그리거트로 기능을 구현할 수 없는 경우 어떻게 구현해야할까?
- 예시로 상품, 주문, 할인 쿠폰, 회원 애그리거트가 있는 경우 '계산 책임'을 어느 애그리거트에게 할당해야하는가?
    - 주문 애그리거트가 '계산 책임'을 가진 경우,
        - 예를 들어 전 품목 한달간 2% 할인 하는 정책일 경우, 주문 애그리거트가 가진 구성요소는 관련 없더라도 수정이 필요함.
    - 따라서, **한 애그리거트에 넣기 애매한 도메인 기능을 억지로 특정 애그리거트에 구현하면 안된다.**
    - 이렇게 구현한 경우 아래 단점이 생김.
        - 코드 길어짐.
        - 외부에 대한 의존이 높아지게 됨 -> 코드가 복잡해져 유지보수가 어려워짐.
    - 따라서, 이런 경우 도메인 기능을 별도의 서비스로 구현하는 것이 좋다.
### 7.2 도메인 서비스
주로 '계산 로직'이거나 '외부 시스템 연동이 필요한 도메인 로직'인 경우 도메인 서비스를 구현한다.
- 상위 예시처럼 한 애그리거트에 넣기 애매한 도메인 개념은 도메인 서비스로 따로 구현하고, 도메인 개념을 명시적으로 드러내면 된다.
- 상태 없이 로직만 구현해야하고, 도메인의 의미가 드러나는 용어를 타입과 메서드명으로 가져야한다.
- 도메인 서비스를 사용하는 주체는 애그리거트가 될 수도 있고 응용 서비스가 될 수도 있다.
    - 그렇다고 도메인 서비스 객체를 애그리거트에 주입하면 안된다. (일부 기능을 위해 굳이 도메인 서비스를 애그리거트에 주입할 필요 없음.)
- 입출금 기능의 경우와 같이 하나로 처리가 되어야할 경우 트랜잭션으로 처리해야하는데,
    - 트랜잭션 처리와 같은 로직은 응용 로직이므로 도메인 서비스가 아닌 응용 서비스에서 처리해야한다.
- 도메인 서비스의 개수가 많거나 엔티티 밸류와 같은 다른 구성요소와 명시적으로 구분하고 싶다면, domain 패키지 아래 domain.model, domain.service, domain.repository와 같이 하위 패키지를 구분하여 위치시켜도 된다.
- 도메인 서비스의 인터페이스를 둔다면 도메인 영역이 특정 구현에 종속되는 것을 방지하고, 도메인 영역의 테스트가 쉬워진다.
    - 인터페이스의 경우 도메인 영역에 위치, 실제 구현은 인프라스트럭처에 위치

### 11.1 단일 모델의 단점
- '주문 내역 조회'기능의 경우 하나의 애그리거트에서 모든 정보를 가져오는 것은 구현을 복잡하게 만들게 된다.
- 이러한 구현 복잡도를 낮추는 간단한 방법은 상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 것이다.

### 11.2 CQRS
- Command and Query Responsibility Segregation의 약자
- 명령(Command)을 위한 모델과 조회(Query)를 위한 모델을 분리하는 패턴
- DDD의 고통을 해결하기 위해서 해당 기법을 사용했다고는 하지만, DDD에 국한되는 것은 아님.
- CQRS는 복잡한 도메인에 적합.
- 예를 들어 명령 모델은 객체 지향에 기반해서 도메인 모델을 구현하기에 적당한 JPA를 사용해서 구현하고, 조회 모델은 DB 테이블에서 SQL로 데이터를 조회할 때 좋은 마이바티스를 이용해서 구현하며 된다.
- 조회모델에서는 응용 서비스가 존재하지 않는다. 따라서 컨트롤러에서 바로 DAO를 실행해도 무방하다.
- 명령 모델과 조회 모델이 서로 다른 저장소를 사용할 수도 있다.
    - ex) 명령 모델은 RDBMS, 조회 모델은 NoSQL을 사용.
    - 두 저장소 간에 동기화의 경우 10장에서 배운 이벤트를 활용해서 처리한다.
    - 동기 이벤트와 글로벌 트랜잭션을 사용해서 실시간으로 동기화 가능하다.
    - 실시간으로 동기화 가능한 장점이 있지만, 전반적인 성능이 떨어지는 단점이 있다.
- 대규모 트래픽이 발생하는 웹 서비스는 알게 모르게 CQRS를 적용하게 된다.
- CQRS의 장단점
    - 장점
    - 명령 모델에서 도메인 자체에 집중하여 구현할 수 있다.
    - 조회를 분리하여 구현 복잡도가 낮아진다.
    - 조회 처리량을 대폭저긍로 늘릴 수도 있다.
    - 단점
    - 구현해야할 코드가 더 많다는 점
    - 더 많은 구현 기술이 필요하다.
- 도메인이 복잡하지 않은데 CQRS를 도입하면 두 모델을 유지하는 비용만 높아지고 얻을 수 있는 이점은 없을 수도 있다.
